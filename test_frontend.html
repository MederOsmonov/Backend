<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç API –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .comment { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .user-info { font-weight: bold; color: #2196F3; }
        .comment-text { margin: 10px 0; }
        .debug { background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .error { color: red; }
        .success { color: green; }
        button { padding: 10px 20px; margin: 5px; }
        input[type="text"] { width: 300px; padding: 5px; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç API –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h1>
    
    <div>
        <h3>1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
        <button onclick="login()">–í–æ–π—Ç–∏ –∫–∞–∫ meder</button>
        <div id="login-status"></div>
    </div>

    <div>
        <h3>2. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
        <button onclick="loadComments()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
        <div id="comments-list"></div>
    </div>

    <div>
        <h3>3. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
        <input type="text" id="comment-input" placeholder="–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è" value="–¢–µ—Å—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <button onclick="createComment()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        <div id="create-result"></div>
    </div>

    <div>
        <h3>4. –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <div id="debug-info"></div>
    </div>

    <script>
        let accessToken = '';
        const API_BASE = 'http://127.0.0.1:8000/api/v1';

        async function login() {
            try {
                const response = await fetch(`${API_BASE}/accounts/auth/login/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: 'meder',
                        password: 'password123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access;
                    document.getElementById('login-status').innerHTML = 
                        '<span class="success">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞</span>';
                } else {
                    document.getElementById('login-status').innerHTML = 
                        '<span class="error">‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</span>';
                }
            } catch (error) {
                document.getElementById('login-status').innerHTML = 
                    `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>`;
            }
        }

        async function loadComments() {
            try {
                const response = await fetch(`${API_BASE}/blog/comments/?post=711`);
                
                if (response.ok) {
                    const data = await response.json();
                    const comments = data.results || [];
                    
                    let html = `<h4>–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${comments.length}</h4>`;
                    
                    comments.slice(0, 3).forEach((comment, index) => {
                        html += `
                            <div class="comment">
                                <div class="debug">
                                    <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ${index + 1} (ID: ${comment.id})</strong><br>
                                    <strong>Raw user data:</strong> ${JSON.stringify(comment.user)}<br>
                                    <strong>Text:</strong> ${comment.text}
                                </div>
                                <div class="user-info">
                                    ${getUserDisplayName(comment.user)}
                                </div>
                                <div class="comment-text">${comment.text}</div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('comments-list').innerHTML = html;
                } else {
                    document.getElementById('comments-list').innerHTML = 
                        '<span class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</span>';
                }
            } catch (error) {
                document.getElementById('comments-list').innerHTML = 
                    `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>`;
            }
        }

        async function createComment() {
            if (!accessToken) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!');
                return;
            }

            const text = document.getElementById('comment-input').value;
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/blog/comments/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        content: text,  // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'content' –∫–∞–∫ –Ω–∞ frontend
                        post: 711
                    })
                });

                if (response.ok) {
                    const newComment = await response.json();
                    
                    document.getElementById('create-result').innerHTML = `
                        <div class="comment">
                            <div class="debug">
                                <strong>–ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ–∑–¥–∞–Ω!</strong><br>
                                <strong>ID:</strong> ${newComment.id}<br>
                                <strong>Raw user data:</strong> ${JSON.stringify(newComment.user)}<br>
                                <strong>Text:</strong> ${newComment.text}
                            </div>
                            <div class="user-info">
                                ${getUserDisplayName(newComment.user)}
                            </div>
                            <div class="comment-text">${newComment.text}</div>
                        </div>
                    `;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    updateDebugInfo(newComment);
                } else {
                    const errorText = await response.text();
                    document.getElementById('create-result').innerHTML = 
                        `<span class="error">‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${response.status} - ${errorText}</span>`;
                }
            } catch (error) {
                document.getElementById('create-result').innerHTML = 
                    `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>`;
            }
        }

        function getUserDisplayName(user) {
            // –≠—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –≤–∞—à–µ–º frontend
            if (!user) {
                return '<span class="error">üë§ –ê–ù–û–ù–ò–ú (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)</span>';
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
            const username = user.username || '';
            const firstName = user.first_name || '';
            const lastName = user.last_name || '';
            const role = user.role || '';

            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
            let displayName = '';
            if (firstName && lastName) {
                displayName = `${firstName} ${lastName}`;
            } else if (firstName) {
                displayName = firstName;
            } else if (username) {
                displayName = username;
            } else {
                displayName = '–ê–Ω–æ–Ω–∏–º';
            }

            return `üë§ ${displayName} (${role}) [${username}]`;
        }

        function updateDebugInfo(comment) {
            const user = comment.user;
            let debugHtml = '<h4>üîç –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</h4>';
            
            debugHtml += `<div class="debug">`;
            debugHtml += `<strong>–ü—Ä–æ–≤–µ—Ä–∫–∏:</strong><br>`;
            debugHtml += `‚Ä¢ comment.user —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${user ? '‚úÖ' : '‚ùå'}<br>`;
            
            if (user) {
                debugHtml += `‚Ä¢ user.username: ${user.username ? '‚úÖ "' + user.username + '"' : '‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}<br>`;
                debugHtml += `‚Ä¢ user.first_name: ${user.first_name ? '‚úÖ "' + user.first_name + '"' : '‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}<br>`;
                debugHtml += `‚Ä¢ user.last_name: ${user.last_name ? '‚úÖ "' + user.last_name + '"' : '‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}<br>`;
                debugHtml += `‚Ä¢ user.role: ${user.role ? '‚úÖ "' + user.role + '"' : '‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}<br>`;
                debugHtml += `‚Ä¢ user.avatar: ${user.avatar ? '‚úÖ "' + user.avatar + '"' : '‚ùå null/–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}<br>`;
                
                debugHtml += `<br><strong>–ü–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç user:</strong><br>`;
                debugHtml += `<pre>${JSON.stringify(user, null, 2)}</pre>`;
            }
            debugHtml += `</div>`;
            
            document.getElementById('debug-info').innerHTML = debugHtml;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏–Ω–∏–º—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            login();
        };
    </script>
</body>
</html>